---
title: "DG precursor exp1"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(lme4)

base_size = 12
theme_set(theme_bw(base_size=base_size) +
            theme(panel.grid.major=element_blank(),
                  panel.grid.minor=element_blank(),
                  legend.key.size=unit(1.5, 'lines'),
                  legend.spacing=unit(0, 'in'),
                  axis.text.x = element_text(angle = 45, hjust = 1)))
```

### Defining functions

```{r}


data_summary <- function(data, varname, groupnames, ci = TRUE){
  require(plyr)
   length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

  data_sum <- data %>% group_by(.dots = groupnames) %>% summarise(N = length2(get(varname)), mean = mean(get(varname), na.rm = TRUE), sd = sd(get(varname), na.rm = TRUE)) %>% rename(!!varname := mean)
  
  if(ci==FALSE){
    return(data_sum)
  }
  else{
    data_sum$se <- data_sum$sd / sqrt(data_sum$N)

  ciMult <- qt(0.95/2 + .5, data_sum$N-1)
  data_sum$ci <- data_sum$se * ciMult
 return(data_sum)
  }
}

# data_summary <- function(data, varname, groupnames){
#   require(plyr)
#    length2 <- function (x, na.rm=FALSE) {
#         if (na.rm) sum(!is.na(x))
#         else       length(x)
#     }
#   summary_func <- function(x, col){
#     c(N    = length2(x[[col]], na.rm=TRUE),
#       mean = mean(x[[col]], na.rm=TRUE),
#       sd = sd(x[[col]], na.rm=TRUE))
#   }
#   data_sum<-ddply(data, groupnames, .fun=summary_func,
#                   varname)
#   data_sum <- rename(data_sum, c("mean" = varname))
#   
#   data_sum$se <- data_sum$sd / sqrt(data_sum$N)
#   
#   ciMult <- qt(0.95/2 + .5, data_sum$N-1)
#   data_sum$ci <- data_sum$se * ciMult
#  return(data_sum)
# }
# 
# data_summ <- function(data, varname, groupnames){
#   require(plyr)
#    length2 <- function (x, na.rm=FALSE) {
#         if (na.rm) sum(!is.na(x))
#         else       length(x)
#     }
#   summary_func <- function(x, col){
#     c(N    = length2(x[[col]], na.rm=TRUE),
#       mean = mean(x[[col]], na.rm=TRUE),
#       sd = sd(x[[col]], na.rm=TRUE))
#   }
#   data_sum<-ddply(data, groupnames, .fun=summary_func,
#                   varname)
#   data_sum <- rename(data_sum, c("mean" = varname))
#  return(data_sum)
# }

```

### Load in data
```{r}

datdir <- '/Users/grushaprasad/Dropbox/Grusha Second Project/psychopy/Exp1/data/'

fname <- 'DGcontext_Exp1'
partnums <- c(1:14)
partnums <- ifelse(partnums < 10, paste("0",as.character(partnums), sep = ""), as.character(partnums))

partids <- paste(fname,"part",partnums, ".csv", sep = "")

all_dat <- NULL

for(part in partids) {
  curr <- read.csv(paste(datdir, part, sep = ""),  header = TRUE)
  curr[6] <- NULL
  all_dat <- rbind(all_dat, curr)
}

all_dat$response_num <- ifelse(all_dat$response == 'G', 1, 0)
all_dat$target_fname <- gsub('./target_stims/', '', all_dat$target_fname)
all_dat$target_fname <- gsub('_CV.wav', '', all_dat$target_fname)

all_dat$coarse <- ifelse(all_dat$cond %in% c('midhigh', 'highmid'), 'high',
                         ifelse(all_dat$cond %in% c('midlow', 'lowmid'), 'low', 'block1'))

all_dat$coarse <- factor(all_dat$coarse)

all_dat$continuum <- as.numeric(regmatches(all_dat$target_fname, gregexpr("[[:digit:]]+", all_dat$target_fname)))

all_dat$proximity <- ifelse(all_dat$cond %in% c('lowmid', 'highmid'), 'near', 'far')
all_dat$context <- ifelse(all_dat$cond %in% c('highmid', 'midhigh'), 'high', 'low')

block1 <- subset(all_dat, cond == 'block1')
block2 <- subset(all_dat, cond != 'block1')

```

### Plotting the categorization curves

```{r}

by_part <- data_summary(all_dat, 'response_num', .(target_fname, cond, part_id))

by_filenum <- data_summary(subset(all_dat,part_id != 'part10'), 'response_num', .(target_fname, cond))

block1 <- subset(by_filenum, cond %in% c('block1'))
by_part_block1 <- subset(by_part, cond %in% c('block1'))

ggplot(block1,
       aes(target_fname, response_num)) + geom_point(position=position_dodge(0.05)) + geom_line(group=1) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) +  labs(x = 'Continuum member', y='% G responses')

ggplot(by_part_block1,
       aes(target_fname, response_num, group = part_id, colour = part_id)) + geom_point() + geom_line() + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05), linetype = 2)  + labs(x = 'Continuum member', y='% G responses')

```


### Coarse plots

```{r}

by_filenum_coarse <- data_summary(all_dat, 'response_num', .(target_fname, coarse))

ggplot(by_filenum_coarse, 
       aes(target_fname, response_num, group = coarse, colour = coarse,linetype = coarse)) + geom_point(position=position_dodge(0.05)) + geom_line(position=position_dodge(0.05)) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) + labs(x = 'Continuum member', y='% G responses') 
```


### Plotting the shift in curve for the low condition

```{r}

ggplot(subset(by_filenum, cond %in% c('block1', 'lowmid', 'midlow')), 
       aes(target_fname, response_num, group = cond, colour = cond,linetype = cond)) + geom_point(position=position_dodge(0.05)) + geom_line(position=position_dodge(0.05)) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) + labs(x = 'Continuum member', y='% D responses') 

ggplot(subset(by_part, cond %in% c('block1', 'lowmid', 'midlow')), 
       aes(target_fname, response_num, group = cond, colour = cond, linetype = cond)) + geom_point(position=position_dodge(0.05)) + geom_line(position=position_dodge(0.05)) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) + labs(x = 'Continuum member', y='% D responses') + facet_wrap(~part_id, nrow = 3)

```

### Plotting the shift in curve for the high condition

```{r}
ggplot(subset(by_filenum, cond %in% c('block1', 'highmid', 'midhigh')), 
       aes(target_fname, response_num, group = cond, colour = cond,linetype = cond)) + geom_point(position=position_dodge(0.05)) + geom_line(position=position_dodge(0.05)) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) + labs(x = 'Continuum member', y='% D responses') 

ggplot(subset(by_part, cond %in% c('block1', 'highmid', 'midhigh')), 
       aes(target_fname, response_num, group = cond, colour = cond, linetype = cond)) + geom_point(position=position_dodge(0.05)) + geom_line(position=position_dodge(0.05)) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) + labs(x = 'Continuum member', y='% D responses') + facet_wrap(~part_id, nrow = 3)
```


### Plotting both

```{r}

by_filenum$cond <- factor(by_filenum$cond, levels = c('lowmid', 'midlow', 'highmid', 'midhigh'))

by_filenum$proximity <- ifelse(by_filenum$cond %in% c('lowmid', 'highmid'), 'near', 'far')
by_filenum$context <- ifelse(by_filenum$cond %in% c('highmid', 'midhigh'), 'high', 'low')

by_part$proximity <- ifelse(by_part$cond %in% c('lowmid', 'highmid'), 'near', 'far')
by_part$context <- ifelse(by_part$cond %in% c('highmid', 'midhigh'), 'high', 'low')

ggplot(subset(by_filenum, cond %in% c('lowmid', 'midlow', 'highmid', 'midhigh')), 
       aes(target_fname, response_num, group = cond, colour = context,linetype = proximity )) + geom_point(position=position_dodge(0.05)) + geom_line(position=position_dodge(0.05)) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) + labs(x = 'Continuum member', y='% G responses') 

ggplot(subset(by_part, cond %in% c('lowmid', 'midlow', 'highmid', 'midhigh')), 
       aes(target_fname, response_num, group = cond, colour = context,linetype = proximity)) + geom_point(position=position_dodge(0.05)) + geom_line(position=position_dodge(0.05)) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) + labs(x = 'Continuum member', y='% G responses') + facet_wrap(~part_id, nrow = 3)

```
### Plotting just the proportion

```{r}

by_cond <- data_summary(all_dat, 'response_num', .(cond,proximity, context))
by_cond$cond <- factor(by_cond$cond, levels = c('midhigh','highmid', 'lowmid', 'midlow'))
by_cond$context <- factor(by_cond$context, levels = c('high', 'low'))

ggplot(subset(by_cond, cond != 'block1'), aes(x = cond, y = response_num, colour = context)) + geom_point(position=position_dodge(0.05))+ geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci)) + labs(x = 'Condition', y='% G responses') 
```


### Descriptive

```{r, cache=TRUE}

block2$cond <- factor(block2$cond, levels = c('highmid', 'midhigh', 'lowmid', 'midlow'))

table(block2$response, block2$cond)
round(prop.table(table(block2$response, block2$cond)) * 100, 2)


```

### Coarse analyses

```{r, cache=TRUE}
all_dat$context <- factor(all_dat$coarse, levels = c('low', 'high', 'block1'))
contrasts(all_dat$context) <- "contr.sum"
contrasts(all_dat$context)

model.coarse <- glmer(response~scale(continuum)*context + (1 + context | part_id ), data = all_dat,  family = binomial(link = "logit"), glmerControl(optimizer="bobyqa"))

model.coarsev2 <- glmer(response~scale(continuum)+context + (1 + context | part_id ), data = all_dat,  family = binomial(link = "logit"), glmerControl(optimizer="bobyqa"))

summary(model.coarse)
summary(model.coarsev2)


```

### Fine grained anaylsis

```{r, cache=TRUE}

block2 <- subset(all_dat, cond !='block1')
block2$proximity <- ifelse(block2$cond %in% c('highmid', 'lowmid'), 'far', 'near')
block2$proximity <- factor(block2$proximity, levels = c('near', 'far'))
block2$context <- factor(block2$context, levels = c('high', 'low'))

contrasts(block2$proximity) <- "contr.sum"
contrasts(block2$proximity)

contrasts(block2$context) <- "contr.sum"
contrasts(block2$context)

model.proximity <- glmer(response~scale(continuum)*proximity*context + (1 + context| part_id ), data = block2,  family = binomial(link = "logit"), glmerControl(optimizer="bobyqa"))

summary(model.proximity)

```



### Including baseline in fine grained analyses?

```{r}

all_dat$proximity <- ifelse(all_dat$cond %in% c('highmid', 'lowmid'), 'far', 
                            ifelse(all_dat$cond %in% c('midhigh', 'midlow'), 'near', 'block1'))
all_dat$proximity <- factor(all_dat$proximity, levels = c('block1', 'near', 'far'))
contrasts(all_dat$proximity) <- "contr.sum"
contrasts(all_dat$proximity)
contrasts(all_dat$f3)

model5 <- glmer(response~scale(continuum) + proximity*f3 + (1 + scale(continuum)| part_id ), data = all_dat,  family = binomial(link = "logit"), glmerControl(optimizer="bobyqa"))

summary(model5)

```


### Looking at the difference betwen first half and second half of the data


```{r}

num.trials_block1 <- max(subset(all_dat, cond == 'block1')$trial_id)
num.trials_block2 <- max(subset(all_dat, cond != 'block1')$trial_id)

# all_dat$half <- ifelse(all_dat$cond == 'block1', 
#                        ifelse(all_dat$trial_id < num.trials_block1/2,  'first', 'second'),
#                        ifelse(all_dat$trial_id < num.trials_block2/2,  'first', 'second'))


all_dat$half <- ifelse(all_dat$cond == 'block1', 'block1', 
                       ifelse(all_dat$trial_id < num.trials_block2/3,  'first', 'second'))
```


```{r}

by_filenum_coarse <- data_summary(all_dat, 'response_num', .(target_fname, coarse, half))

ggplot(by_filenum_coarse, 
       aes(target_fname, response_num, group = coarse, colour = coarse,linetype = coarse)) + geom_point(position=position_dodge(0.05)) + geom_line(position=position_dodge(0.05)) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) + labs(x = 'Continuum member', y='% G responses') + facet_wrap(~half)

```

```{r}

by_filenum <- data_summary(subset(all_dat,part_id != 'part10'), 'response_num', .(target_fname, cond, half))


by_filenum$cond <- factor(by_filenum$cond, levels = c('lowmid', 'midlow', 'highmid', 'midhigh'))

by_filenum$proximity <- ifelse(by_filenum$cond %in% c('lowmid', 'highmid'), 'near', 'far')
by_filenum$context <- ifelse(by_filenum$cond %in% c('highmid', 'midhigh'), 'high', 'low')

by_part$proximity <- ifelse(by_part$cond %in% c('lowmid', 'highmid'), 'near', 'far')
by_part$context <- ifelse(by_part$cond %in% c('highmid', 'midhigh'), 'high', 'low')

ggplot(subset(by_filenum, cond %in% c('lowmid', 'midlow', 'highmid', 'midhigh')), 
       aes(target_fname, response_num, group = cond, colour = context,linetype = proximity )) + geom_point(position=position_dodge(0.05)) + geom_line(position=position_dodge(0.05)) + geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci), width=.2,position=position_dodge(0.05)) + labs(x = 'Continuum member', y='% G responses') + facet_wrap(~half)


```


```{r}

by_cond <- data_summary(all_dat, 'response_num', .(cond,proximity, context, half))
by_cond$cond <- factor(by_cond$cond, levels = c('midhigh','highmid', 'lowmid', 'midlow'))
by_cond$context <- factor(by_cond$context, levels = c('high', 'low'))

ggplot(subset(by_cond, cond != 'block1'), aes(x = cond, y = response_num, colour = context)) + geom_point(position=position_dodge(0.05))+ geom_errorbar(aes(ymin=response_num-ci, ymax=response_num+ci)) + labs(x = 'Condition', y='% G responses') + facet_wrap(~half)

```